name: Deploy to VM via SSH

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Java 17 세팅
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Node.js 세팅
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Python 세팅
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14'

      # Python 의존성 설치 및 데이터 생성
      - name: Install Dependencies & Fetch Real Data
        run: |
          pip install -r requirements.txt
          python scripts/fetch_data.py

      # 프론트엔드 빌드 & 통합
      - name: Build Frontend & Copy
        working-directory: ./FRONT/companyvalue
        run: |
          npm ci
          npm run build
          mkdir -p ../../BACK/companyvalue/src/main/resources/static
          cp -r dist/* ../../BACK/companyvalue/src/main/resources/static/

      # 백엔드(Spring Boot) 빌드
      - name: Build Backend (Gradle)
        working-directory: ./BACK/companyvalue
        run: |
          chmod +x gradlew
          # [수정] --refresh-dependencies 옵션 추가 (403 에러 해결용)
          ./gradlew clean build -x test --refresh-dependencies

      # Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Docker 이미지 빌드 & Push
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./BACK/companyvalue
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/value-pick:latest

      # 설정 파일(운영용 Compose & Nginx 설정)을 서버로 전송
      - name: Copy Docker Compose & Config to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # docker-compose.prod.yml 과 nginx 설정 폴더를 전송
          source: "docker-compose.prod.yml,nginx/conf.d/default.conf"
          target: "/home/${{ secrets.VM_USERNAME }}/company_value_project"

      # 서버에 SSH 접속해서 배포 명령 실행
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.VM_USERNAME }} # GCP VM의 사용자명 (보통 구글계정 아이디 앞부분)
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 프로젝트 폴더로 이동
            cd /home/${{ secrets.VM_USERNAME }}/company_value_project

            # .env 파일 생성 (환경변수 주입)
            echo "DB_ROOT_PASSWORD=${{ secrets.DB_PASSWORD }}" > .env
            echo "JWT_SECRET_KEY=${{ secrets.JWT_SECRET }}" >> .env
            echo "API_FRED_KEY=${{ secrets.FRED_API_KEY }}" >> .env
            echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> .env
            # [추가] Docker Hub 로그인 (Private Repo 접근 권한 확보)
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            # 최신 이미지 Pull (prod 파일 기준)
            docker compose -f docker-compose.prod.yml pull
            
            # 컨테이너 강제 재생성 (--force-recreate)
            # 이미지가 변경되지 않았더라도 확실하게 다시 띄운다.
            docker compose -f docker-compose.prod.yml up -d
            
            # 불필요한 구버전 이미지 정리
            docker image prune -f