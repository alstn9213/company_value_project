name: Deploy to VM via SSH

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Java 17 세팅
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 2. Node.js 세팅
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. 프론트엔드 빌드 & 통합
      - name: Build Frontend & Copy
        working-directory: ./FRONT/companyvalue
        run: |
          npm ci
          npm run build
          mkdir -p ../../BACK/companyvalue/src/main/resources/static
          cp -r dist/* ../../BACK/companyvalue/src/main/resources/static/

      # 4. 백엔드(Spring Boot) 빌드
      - name: Build Backend (Gradle)
        working-directory: ./BACK/companyvalue
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      # 5. Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6. Docker 이미지 빌드 & Push
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./BACK/companyvalue
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/value-pick:latest

      # 7. 서버에 SSH 접속해서 배포 명령 실행
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.VM_USERNAME }} # GCP VM의 사용자명 (보통 구글계정 아이디 앞부분)
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker pull ${{ secrets.DOCKER_USERNAME }}/value-pick:latest
            docker stop app-server || true
            docker rm app-server || true
            
            docker run -d \
              --name app-server \
              --network host \
              -e SPRING_DATASOURCE_URL="jdbc:mariadb://127.0.0.1:3306/value" \
              -e SPRING_DATASOURCE_USERNAME="root" \
              -e SPRING_DATASOURCE_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              -e JWT_SECRET_KEY="${{ secrets.JWT_SECRET }}" \
              -e API_ALPHAVANTAGE_KEY="${{ secrets.ALPHA_API_KEY }}" \
              -e API_FRED_KEY="${{ secrets.FRED_API_KEY }}" \
              ${{ secrets.DOCKER_USERNAME }}/value-pick:latest

            docker image prune -f