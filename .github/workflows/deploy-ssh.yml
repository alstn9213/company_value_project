name: Deploy to VM via SSH

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      # Python 세팅
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14'

      # Python 의존성 설치 및 데이터 생성
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      # 이 스크립트가 실행되면 src/main/resources/data/seed_data.json 파일이 갱신된다.
      - name: Fetch fresh company data
        run: |
          python scripts/fetch_data.py
          
      # Node.js 세팅
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 프론트엔드 빌드 & 통합
      - name: Build Frontend & Copy to Backend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build
          # 백엔드의 static 폴더가 없으면 생성
          mkdir -p ../../backend/src/main/resources/static
          # 기존 파일 삭제 (혹시 모를 잔여물 제거)
          rm -rf ../../backend/src/main/resources/static/*
          # 빌드 결과물(dist) 내부 파일들을 백엔드 static으로 복사
          cp -r dist/* ../../backend/src/main/resources/static/

          # 복사 잘 됐는지 확인용 출력
          echo "Listing static files:"
          ls -R ../../backend/src/main/resources/static/

      # Java 17 세팅
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 백엔드(Spring Boot) 빌드
      - name: Build Backend (Gradle)
        working-directory: ./backend
        run: |
          chmod +x gradlew
          # clean build를 해야 복사된 static 파일들이 확실하게 jar에 포함됨
          # --refresh-dependencies 옵션 추가 (403 에러 해결용)
          ./gradlew clean build -x test --refresh-dependencies

      # Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Docker 이미지 빌드 & Push
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/value-pick:latest

      # 설정 파일(운영용 Compose & Nginx 설정)을 서버로 전송
      - name: Copy Docker Compose & Config to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # docker-compose.prod.yml 과 nginx 설정 폴더를 전송
          source: "docker-compose.prod.yml,nginx/conf.d/default.conf,init-letsencrypt.sh"
          target: "/home/${{ secrets.VM_USERNAME }}/company_value_project"

      # 서버에 SSH 접속해서 배포 명령 실행
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.VM_USERNAME }} # GCP VM의 사용자명 (보통 구글계정 아이디 앞부분)
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 프로젝트 폴더로 이동
            cd /home/${{ secrets.VM_USERNAME }}/company_value_project

            # .env 파일 생성 (환경변수 주입)
            echo "DB_ROOT_PASSWORD=${{ secrets.DB_PASSWORD }}" > .env
            echo "JWT_SECRET_KEY=${{ secrets.JWT_SECRET }}" >> .env
            echo "API_FRED_KEY=${{ secrets.FRED_API_KEY }}" >> .env
            echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> .env
            # Docker Hub 로그인 (Private Repo 접근 권한 확보)
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            # 최신 이미지 Pull & 재실행
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --force-recreate
            docker image prune -f