# 주가 데이터 수집 및 캐싱 전략

## 1. 배경 (Context)
본 프로젝트(`Value Pick`)는 기업의 가치 평가(Valuation)를 위해 **주가 데이터**가 필수적입니다. PER, PBR 등의 핵심 지표는 어디까지나 재무 제표의 과거 수치에 기반하여 계산되기 때문에 재무 제표 공시일 이후로 주가 변동이 있었다면, 본 프로젝트에서 제공하는 기업 평가와 실제 시장 평가 사이에 큰 괴리가 생기기 때문입니다. 하지만 현재 사용 중인 **Alpha Vantage API (Free Tier)**는 다음과 같은 제약 사항이 있어, 일반적인 실시간 호출 방식을 적용하기 어렵습니다.

* **API 제약:** 분당 5회, 하루 25회 호출 제한.
* **위험 요소:** 사용자가 상세 페이지에 진입할 때마다 API를 호출하면, 동시 접속자가 5명만 되어도 API 키가 차단되고 서비스 장애로 이어짐.

## 2. 대안 분석 (Alternatives)

### 1안: 실시간 API 호출 (On-Demand)
* **방식:** 사용자가 페이지를 요청할 때마다 외부 API 호출.
* **장점:** 구현이 가장 단순하고, 항상 최신 데이터를 보장함.
* **단점:** 트래픽이 조금만 몰려도 API 제한에 걸려 서비스가 마비됨. 포트폴리오용으로 부적합.

### 2안: Redis를 이용한 API 응답 캐싱
* **방식:** API 응답을 Redis에 저장하고, 만료(TTL) 전까지는 재사용.
* **장점:** 동일한 기업을 여러 번 조회할 때는 효과적임.
* **단점:** **서로 다른 기업**을 동시다발적으로 조회하는 시나리오(예: 면접관 여러 명이 각자 다른 종목 클릭)에서는 방어가 불가능함.

### 3안: 배치(Batch) 수집 + DB/Redis 이중 구조 (채택)
* **방식:**
    1. **수집:** 사용자의 요청과 무관하게, **스케줄러**가 정해진 시간(새벽)에 천천히(12초 간격) API를 호출하여 DB에 저장.
    2. **조회:** 사용자는 DB에 저장된 데이터를 조회함. 조회 성능 최적화를 위해 Redis를 DB의 캐시 계층으로 활용.
* **장점:** API 호출 횟수를 개발자가 100% 통제할 수 있어 안전함. 사용자 응답 속도가 매우 빠름.
* **단점:** 데이터의 최신성이 하루 정도 지연될 수 있음 (가치 투자 분석 목적에는 부합하므로 수용 가능).

## 3. 결정 (Decision)
**"3안: 배치 수집 + DB/Redis 이중 구조"**를 채택합니다.

### 상세 구현 전략
1.  **목록 페이지 (전일 종가):**
    * `SchedulingService`가 매일 새벽(07:00 KST) 실행.
    * 12초 간격으로 `GLOBAL_QUOTE` API를 호출하여 `Company` 테이블의 `currentPrice` 필드 갱신.
2.  **상세 페이지 (차트 데이터):**
    * **Safe On-Demand 전략:** 사용자 요청 시 `StockService`가 개입.
    * **Flow:** `Redis` 확인 → (없으면) `DB` 확인 → (없으면, 최초 1회만) `API` 호출 후 DB/Redis 저장.
    * **Redis TTL:** 차트 데이터(`stock_history`)는 6시간으로 설정하여 적절한 갱신 주기 유지.

## 4. 결과 (Consequences)
* **안정성:** 트래픽 급증 상황에서도 외부 API 호출량은 '0'으로 유지되어 서비스 중단 위험이 제거됨.
* **성능:** 대부분의 요청이 In-Memory(Redis) 또는 DB에서 처리되므로 응답 속도가 획기적으로 개선됨 (수 초 -> 수 밀리초).
* **확장성:** 향후 유료 API로 전환 시, 스케줄러의 주기만 조정하면 되어 유연한 확장이 가능함.